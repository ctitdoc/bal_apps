import ballerina/websocket;
import ballerina/http;
import ballerina/log;
import ballerina/task;

type WebSocketConf record {
    int port = 9091;
};

configurable WebSocketConf websocket = ?;

map<websocket:Caller> clientMap = {};

service /ws on new websocket:Listener(websocket.port) {
    resource function get .(http:Request req) returns ZeroKmService {
        return new ZeroKmService();
    }
}

service class ZeroKmService {
    *websocket:Service;

    remote function onOpen(websocket:Caller caller) returns error? {
        clientMap[caller.getConnectionId()] = caller;
        log:printInfo(string `Opened a WebSocket connectioni with ID: ${caller.getConnectionId()}`);
    }

    remote function onClose(websocket:Caller caller, int statusCode, string reason) {

        _ = clientMap.remove(caller.getConnectionId());
        log:printInfo(string `Client closed ${caller.getConnectionId()} connection with status ${statusCode} because of ${reason}`);
    }

    remote function onError(websocket:Caller caller, error err) {
        log:printError(err.message());
    }

}

public function createZeroKmJob() returns task:JobId|error {
    return check task:scheduleJobRecurByFrequency(
                            new ZeroKmJob(), 5);
}

class ZeroKmJob {
    *task:Job;

    public function execute() {
        log:printInfo("execution de l'envoi...");
        // json payload = { "example": "Hello World"}

        json payload = {
            "iId": 939048,
            "sTypnatcode": "210003",
            "iVehicleType": 1,
            "iVehicleStatut": 103,
            "sVehicleStatutLibelle": "Disponible à la vente",
            "sBrandName": "PEUGEOT",
            "iBrandNatCode": 2,
            "iModelNatCode": 6056,
            "sName": "208 AFFAIRE BLUEHDI 100 S&S BVM5",
            "sNameBis": "PREMIUM PACK",
            "sModel": "208 AFFAIRE",
            "bMetallicPaint": false,
            "iNumberOfCylinders": 4,
            "iNumberOfDoors": 5,
            "sEngineType": "Ligne",
            "fHorseTax": 0,
            "fHorsePower": 100,
            "fPower": 75,
            "fCapacity": 1499,
            "sTransmission": "Traction avant",
            "iNumberOfGears": 5,
            "sGearboxType": "Boîte manuelle",
            "sFuel": "Diesel",
            "sBody": "Berline",
            "iNumberOfSeats": 2,
            "sFrontTires": "185/65 R 15",
            "sBackTires": "185/65 R 15",
            "iMaxSpeed": 188,
            "fAccelerationTime": "10.5",
            "fUrbanConsumption": "4.6",
            "fLandConsumption": "3.4",
            "fMixedConsumption": "3.7",
            "iCO2Emission": 98,
            "iLength": 3973,
            "iWidth": 1829,
            "iHeight": 1460,
            "iWheelBase": 2538,
            "iTotalWeight": 1640,
            "iEmptyWithDriverWeight": 1080,
            "iTrunkMaxCapacity": null,
            "iTrunkMinCapacity": 1062,
            "iPayload": 560,
            "iRoofLoad": null,
            "bConsignment": "",
            "sPutawayDate": "2024-12-05",
            "sMECDate": "2020-10-23",
            "aEquipmentGroups": ["..."],
            "aC34TagsDTO": null,
            "aPictures": [
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_0.jpg?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d270363bbcf909617efbbf1165e1de2d46_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_1.jpg?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d235116573ed6e7794fbbf1165e1de2d46_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_2.jpg?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d2266cd9ec72b3f623fbbf1165e1de2d46_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_3.jpg?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d23747614ae506b83efbbf1165e1de2d46_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_4.jpg?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d26664ff3a602bc7fafbbf1165e1de2d46_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_5.jpg?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d25b8645319aea33d3fbbf1165e1de2d46_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_6.jpg?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d2c5e109d6d7a2f429fbbf1165e1de2d46_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_7.jpg?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d28170527b8b30edcdfbbf1165e1de2d46_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_8.png?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d2448cb7214cc57b3ccded19e9ccc9a4fb_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_9.png?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d22c322c1f4cf5f2a5cded19e9ccc9a4fb_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_10.png?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d27a359a319443d9d8cded19e9ccc9a4fb_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_11.png?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d214691a83818fd82ecded19e9ccc9a4fb_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_12.png?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d2008d3f46d1b886fbcded19e9ccc9a4fb_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_13.png?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d2e08b43899e0532bacded19e9ccc9a4fb_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_14.png?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d2d675a450e66300cdcded19e9ccc9a4fb_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_15.png?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d2b579a59f234c9951cded19e9ccc9a4fb_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_16.png?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d2efab6aa350c4b512cded19e9ccc9a4fb_2",
                "https://file-render.webapp4you.eu/pictureRender/peugeot_208-affaire-bluehdi-100-ss-bvm5_premium-pack_17.png?id=75967ed03ba602fe49c63218f699e672fddeb6c576b753785a58641b4c0e58261e886f4d5dfb09070be4828518bdb1545af5682b477376d27e7720c2612b01e5cded19e9ccc9a4fb_2"
            ],
            "iNbPhoto": 18,
            "sReference": "FON4974",
            "sNumeroChassis": "VF3CCYHYPLW022147",
            "bEurotaxe": true,
            "sPVELibelle": "Elite Auto  Fontenay",
            "sPVEAdresse1": "11 Rue de l'Orme",
            "sPVEAdresse2": null,
            "sPVEAdresseAdd1": null,
            "sPVEAdresseAdd2": null,
            "sPVECP": "91540",
            "sPVEVille": "Fontenay-le-Vicomte",
            "sPVETelFax": null,
            "sPVETelFixe": "01 64 57 20 00",
            "sPVEEmail": "occasions@elite-auto.fr",
            "fPVELatitude": "48.5475536",
            "fPVELongitude": "2.4065099",
            "aSitePresencePhysique": {
                "sLibelle": "CHOUFFOT",
                "sAdresse1": "Avenue Saint-Rémi",
                "sAdresse2": null,
                "sAdresseAdd1": null,
                "sAdresseAdd2": null,
                "sCP": "91540",
                "sVille": "Fontenay-le-Vicomte",
                "sTelFax": null,
                "sTelFixe": null,
                "sEmail": null,
                "fLatitude": "48.5512538",
                "fLongitude": "2.4090029"
            },
            "sCouleurExt": "BLANC",
            "sCouleurInt": "Noir",
            "sGuarantee": "Garantie Elite Auto 12 mois ou 15000 km maximum",
            "fTotalPrice": "7455.00",
            "i_cli_id": 1334,
            "i_pve_id": 454,
            "fPourcentageRemiseGlobale": "-5.98991",
            "gen_f_veh_prix_base": "19200.00",
            "gen_f_veh_prix_accessoires": 0,
            "gen_i_veh_bandeau_niveau_2": 0,
            "gen_f_total_equipements": 0,
            "gen_f_total_accessoires_ttc": 0,
            "gen_f_total_remise_par_accessoire": 0,
            "s_veh_critair": "2",
            "s_veh_norme_euro": null,
            "s_veh_numero_reception_type": null,
            "cnit": null,
            "b_veh_tva_recuperable": true,
            "aServicesExternes": [],
            "f_veh_soh_score": null,
            "d_veh_soh_date_certificat": null,
            "d_veh_soh_date_expiration_certificat": null,
            "gen_s_url_soh_certificat": null,
            "s_pub_commentaire_publication": null,
            "iMileage": 122650,
            "bGuaranteedMileage": false,
            "bDepotVente": false,
            "bFirstHand": false,
            "bImport": false,
            "fTotalPriceMerchant": "7200.00",
            "i_veh_destination": 1,
            "sGuaranteeLength": "12 mois",
            "sOrigineVo": "Société",
            "sContactTel": null,
            "sContactTelPort": null,
            "sContactEmail": null,
            "aVideos": [
                {
                    "s_vvi_url": "https://mycarlab.fr/player/b2l/preview/939048",
                    "i_vvi_gabarit": 6
                }
            ],
            "i_veh_site_presence_physique": null,
            "i_veh_site_presence_physique_spp": 283,
            "gen_s_veh_site_presence_physique": "CHOUFFOT",
            "gen_s_veh_site_presence_physique_spp": "CHOUFFOT",
            "d_veh_date_mec": "2020-10-23",
            "s_veh_typtxtfueltypecd2lbl_traductions": null,
            "s_veh_typtxtbodyco1cd2lbl_traductions": null,
            "i_veh_kilometre": 122650,
            "s_veh_garantie_type": "moteur boite pont",
            "s_veh_garantie_libelle": "Garantie Elite Auto 12 mois ou 15000 km maximum",
            "s_veh_garantie_duree": "12 mois",
            "d_veh_garantie_duree": null,
            "f_veh_typhp": 100,
            "s_veh_typtxttranstypecd2lbl": "Boîte manuelle",
            "s_veh_typtxttranstypecd2lbl_traductions": null,
            "i_veh_360_statut": 0,
            "dh_veh_derniere_modification": "2025-04-26 10:41:21",
            "s_pve_libelle": "Elite Auto  Fontenay",
            "s_pve_cp": "91540",
            "s_pve_ville": "Fontenay-le-Vicomte",
            "gen_f_veh_distance": null,
            "sUrlFirstImage360": null,
            "iVehicleId": 939048,
            "sBrand": "PEUGEOT",
            "fTypTaxHp": 0,
            "fPrice": "7455.00",
            "i_veh_typeconfiguration": 1,
            "s_veh_typnatcode": "210003",
            "i_veh_statut": 103,
            "s_veh_id_externe": "VO_12803",
            "i_veh_id": 939048,
            "sIDCrypte": "60c5134a9c861f7f_2",
            "s_lan_code_complet": "fr-FR",
            "i_veh_maknatcode": 2,
            "i_veh_modnatcode": 6056,
            "i_veh_typvalvpcyl": 2,
            "i_veh_typcylinder": 4,
            "i_veh_typnumgearf": 5,
            "i_veh_typwheelb1": 2538,
            "i_veh_typseat": 2,
            "i_veh_typdoor": 5,
            "i_veh_tcoco2emi": 98,
            "i_veh_zvevehtype": 30,
            "i_veh_typtotwgt": 1640,
            "i_veh_typlength": 3973,
            "i_veh_typwidth": 1829,
            "i_veh_typheight": 1460,
            "i_veh_tcotopspeed": 188,
            "i_veh_tecpayload": 560,
            "i_veh_typroofload": null,
            "i_veh_typtrunkcapmax": null,
            "i_veh_typtrunkcapmin": 1062,
            "i_veh_typcurbwgt": 1080,
            "f_veh_typtaxhp": 0,
            "i_veh_asking_price": null,
            "i_veh_typvehtype": null,
            "i_veh_niveau_qualif": 1,
            "i_com_id_conseiller_commercial": null,
            "i_veh_referentiel": 1,
            "i_veh_sas": 3,
            "i_veh_tconumbat": null,
            "i_veh_tcobatcap": null,
            "i_veh_tcobatpow": null,
            "i_veh_batautonomy": null,
            "i_veh_tconumcharcycl": null,
            "i_veh_pays_import": null,
            "i_veh_ch2wltpco2emicomb": null,
            "i_veh_ch2wltpco2emicombmax": null,
            "i_veh_batautonomywltp": null,
            "i_veh_batautonomywltpmax": null,
            "i_veh_batautonomywltpcity": null,
            "i_veh_batautonomywltpcitymax": null,
            "i_veh_type_boite_vitesse": 2,
            "s_veh_makname": "PEUGEOT",
            "s_veh_modname": "208 AFFAIRE (05/2015-07/2020)",
            "s_veh_modname2": "208 AFFAIRE",
            "s_veh_modnamegrp1": "208 AFFAIRE",
            "s_veh_modnamegrp2": "208 AFFAIRE",
            "s_veh_typname": "208 AFFAIRE BLUEHDI 100 S&S BVM5",
            "s_veh_typname2": "PREMIUM PACK",
            "s_veh_typtxtfueltypecd2": "00100003",
            "s_veh_typtxtfueltypecd2lbl": "Diesel",
            "s_veh_typtxtbodyco1cd2": "00010060",
            "s_veh_typtxtbodyco1cd2lbl": "Berline",
            "s_veh_typtxtseg1cd2": "00030024",
            "s_veh_typtxtseg1cd2lbl": "Utilitaires dérivés de petits vp",
            "s_veh_typtxtcylarrcd2": "00080001",
            "s_veh_typtxtcylarrcd2lbl": "Ligne",
            "s_veh_typtxtexhtreatcd2": "00170010",
            "s_veh_typtxtexhtreatcd2lbl": "Filtre à particules et oxy.cat",
            "s_veh_typtxttranstypecd2": "00180001",
            "s_veh_typtxtdrivetypecd2": "00050001",
            "s_veh_typtxtdrivetypecd2lbl": "Traction avant",
            "s_veh_typimpbegin": "201812",
            "s_veh_typimpend": "202007",
            "s_veh_prhval": "20200629",
            "s_veh_tsespecdesc": null,
            "s_veh_tcenum": null,
            "s_veh_vocordercode": "1PIAADLMDJB0A0H8",
            "s_veh_zvedescrshort": "VU",
            "s_veh_zvedescr": "Véhicule utilitaire",
            "s_veh_pneus_avant": "185/65 R 15",
            "s_veh_pneus_arriere": "185/65 R 15",
            "s_veh_couleur_exterieure": "BLANC",
            "s_veh_couleur_interieure": "Noir",
            "s_veh_couleur_exterieure_ref": "Blanc",
            "s_veh_couleur_interieure_ref": "Noir",
            "s_veh_couleur_exterieure_code": null,
            "s_veh_couleur_interieure_code": null,
            "s_veh_code_postal": "91540",
            "s_veh_prhvaluntil": null,
            "s_veh_immatriculation": "FT-528-QT",
            "s_veh_numero_chassis": "VF3CCYHYPLW022147",
            "s_veh_origine": "WS",
            "s_veh_numero_interne": "FON4974",
            "s_veh_telephone": null,
            "s_veh_email": null,
            "s_veh_commentaire": null,
            "s_veh_num_carte_grise": null,
            "s_veh_reference_emplacement": null,
            "s_veh_code_atelier": null,
            "s_veh_localisation_cle": null,
            "s_veh_tcotxtbattypecd2": null,
            "s_veh_tcotxtbattypecd2lbl": null,
            "s_veh_hybridtype": null,
            "s_veh_hybridtypelbl": null,
            "s_veh_energysupp": null,
            "s_veh_energysupplbl": null,
            "s_veh_tcoconsgas": null,
            "s_veh_tcoconsgaslbl": null,
            "s_veh_tcotxtconsgasunitcd": null,
            "s_veh_tcotxtconsgasunitcdlbl": null,
            "s_veh_typtxtpowertraintypecd2": null,
            "s_veh_typtxtpowertraintypecd2lbl": null,
            "s_veh_stock_exchange_id": "5592",
            "s_veh_stock_exchange_localisation": null,
            "s_veh_model_year": null,
            "f_veh_typtorque": "250.00",
            "f_veh_typcaptech": 1499,
            "f_veh_typkw": 75,
            "f_veh_tcoconstot": "3.7",
            "f_veh_tcoconsurb": "4.6",
            "f_veh_tcoconsland": "3.4",
            "f_veh_prhnp1": "19200.00",
            "f_veh_prhnp2": "16000.00",
            "f_veh_prhtaxrt": 0,
            "f_veh_tcoaccel": "10.5",
            "f_veh_prix_vente": "7455.00",
            "f_veh_prix_vente_offline": "7455.00",
            "f_veh_tva_taux": "20.00",
            "f_veh_contrat_garantie": null,
            "f_veh_contrat_entretien": null,
            "f_veh_bonus_malus": null,
            "f_veh_malus_poids": null,
            "f_veh_facture_prix": null,
            "f_veh_tcoconspow": null,
            "f_veh_tcochartime": null,
            "f_veh_tcochartime_fast": null,
            "f_veh_tcoconsgasurb": null,
            "f_veh_tcoconsgasland": null,
            "f_veh_tcoconsgastot": null,
            "f_veh_typkw_ice": null,
            "f_veh_typhp_ice": null,
            "f_veh_typtorque_ice": null,
            "f_veh_tieepeakpowerkw": null,
            "f_veh_tieepeakpowerhp": null,
            "f_veh_tieepeaktorque": null,
            "f_veh_ch2wltpconslow": null,
            "f_veh_ch2wltpconslowmax": null,
            "f_veh_ch2wltpconsmedium": null,
            "f_veh_ch2wltpconsmediummax": null,
            "f_veh_ch2wltpconshigh": null,
            "f_veh_ch2wltpconshighmax": null,
            "f_veh_ch2wltpconsextrahigh": null,
            "f_veh_ch2wltpconsextrahighmax": null,
            "f_veh_ch2wltpconscomb": null,
            "f_veh_ch2wltpconscombmax": null,
            "f_veh_ch2wltpconsgaslow": null,
            "f_veh_ch2wltpconsgaslowmax": null,
            "f_veh_ch2wltpconsgasmedium": null,
            "f_veh_ch2wltpconsgasmediummax": null,
            "f_veh_ch2wltpconsgashigh": null,
            "f_veh_ch2wltpconsgashighmax": null,
            "f_veh_ch2wltpconsgasextrahigh": null,
            "f_veh_ch2wltpconsgasextrahighmax": null,
            "f_veh_ch2wltpconsgascomb": null,
            "f_veh_ch2wltpconsgascombmax": null,
            "f_veh_ch2wltpconspowcomb": null,
            "f_veh_ch2wltpconspowcombmax": null,
            "f_veh_tcochartime_accel": null,
            "gen_i_nb_photo": null,
            "gen_i_nb_photo_360": null,
            "gen_i_nb_photo_obligatoire": null,
            "gen_i_nb_photo_autre": null,
            "gen_i_nb_photo_gabarit": null,
            "gen_f_pourcentage_remise_globale": 0,
            "gen_s_veh_libelle_statut": "Disponible à la vente",
            "gen_b_veh_publie": null,
            "gen_i_veh_nbjoursprix": "0",
            "gen_i_veh_nbjoursstock": "142",
            "i_veh_option_com_id": null,
            "gen_b_veh_option_vendeur": false,
            "gen_s_veh_option_vendeur": "",
            "i_veh_type_option": null,
            "dh_veh_option_levee": null,
            "i_veh_option_con_id": null,
            "gen_i_ereservation": null,
            "d_veh_date_carte_grise": null,
            "d_veh_livraison": null,
            "d_veh_date_entree_stock": "2024-12-05",
            "dh_veh_premiere_image": "2024-12-06 11:51:53",
            "dh_veh_facture_date": null,
            "d_veh_date_achat": null,
            "b_veh_peinture_metal": false,
            "b_veh_supprime": false,
            "b_veh_referenced": true,
            "b_veh_eurotax": true,
            "b_veh_co2_certifie": false,
            "i_veh_dernier_statut_generique": 103,
            "aCEquipementDTO": ["..."],
            "aCVehiculeImageDTO": ["..."],
            "aCVehiculeVideoDTO": null,
            "a360": null,
            "insCCSPacklivraisonDTO": null,
            "aCCSAccessoiresDTO": null,
            "i_cmd_id": null,
            "dh_cmd_validation": null,
            "i_veh_spot": 7930,
            "i_veh_service_cotation": 1,
            "s_veh_url_analysis": null,
            "s_veh_url_quotation": null,
            "i_veh_spotajuste": null,
            "i_veh_radar_nbjours": 55,
            "i_rep_id": null,
            "i_enc_id": null,
            "i_off_id": null,
            "i_con_id_ancien_proprietaire": null,
            "i_veh_soumis_lpe_vn": null,
            "i_com_id_demandeur": null,
            "i_com_id_valideur": null,
            "i_com_id_repreneur": null,
            "b_veh_accidente": false,
            "b_veh_non_roulant": false,
            "b_veh_transforme": false,
            "b_veh_premiere_main": false,
            "b_veh_import": false,
            "b_veh_depotvente": false,
            "b_veh_km_garanti": false,
            "b_veh_aucun_frevo_reel": false,
            "b_veh_prepare": false,
            "b_veh_vendable": false,
            "b_veh_vo_contremarque": false,
            "f_veh_prix_vente_propose_marchand": "7200.00",
            "f_veh_prix_vente_encheriste": null,
            "f_veh_frevo_estimes_ht": "250.00",
            "f_veh_frevo_estimes_ttc": "300.00",
            "f_veh_frevo_contre_estimes_ht": null,
            "f_veh_frevo_contre_estimes_ttc": null,
            "f_veh_frevo_contre_expertises_ht": null,
            "f_veh_frevo_contre_expertises_ttc": null,
            "f_veh_frevo_refactures_ht": null,
            "f_veh_frevo_refactures_ttc": null,
            "f_veh_frevo_contre_expertises_abattement": null,
            "f_veh_frevo_contre_expertises_prix_cession_ht": null,
            "f_veh_frevo_contre_expertises_prix_cession_ttc": null,
            "f_veh_frevo_mecanique_ht": "1443.66",
            "f_veh_frevo_carrosserie_ht": null,
            "f_veh_frevo_sous_traitance_ht": null,
            "f_veh_transfert_marge": "0.00",
            "f_veh_aide_reprise_ht": null,
            "s_veh_aide_reprise_libelle": "Aide à la reprise",
            "f_veh_aide_reprise_2_ht": null,
            "s_veh_aide_reprise_2_libelle": "Aide à la reprise 2",
            "f_veh_prix_reprise_ht": "4251.67",
            "f_veh_prix_reprise_ttc": "5102.00",
            "f_veh_prix_rentree_ht": "4251.67",
            "f_veh_prix_rentree_ttc": "5102.00",
            "f_veh_frevo_reels_ht": "1443.66",
            "f_veh_frevo_reels_ttc": "1732.39",
            "f_veh_controle_technique_ht": null,
            "f_veh_controle_technique_ttc": null,
            "f_enc_prix_propose": null,
            "f_asp_valeur_1": null,
            "f_asp_valeur_2": null,
            "f_asp_valeur_3": null,
            "f_veh_prix_vente_conseille_ttc": "7455.00",
            "f_veh_tva_sur_marge": "0.00",
            "f_veh_marge_commerciale_ht": "434.47",
            "f_veh_marge_commerciale_init_ht": null,
            "f_veh_marge_commerciale_init_ttc": null,
            "f_veh_prix_reprise_client_scanvo_ht": null,
            "f_veh_prix_reprise_client_scanvo_ttc": null,
            "f_veh_frais_financier_ht": "82.70",
            "f_veh_frais_financier_ttc": "99.24",
            "f_veh_frais_financier_init_ht": null,
            "f_veh_frais_financier_init_ttc": null,
            "f_veh_frais_pro_ttc": null,
            "f_veh_frais_pro_ht": null,
            "f_veh_frais_pro_init_ttc": null,
            "f_veh_frais_pro_init_ht": null,
            "f_veh_marge_brute_ht": "1960.83",
            "f_veh_marge_brute_init_ht": null,
            "s_veh_source_achat": null,
            "s_veh_origine_vo": "Société",
            "s_veh_valideur": null,
            "s_veh_vendeur_repreneur": null,
            "s_veh_ancien_proprietaire": "BYMYCAR TRADING",
            "f_veh_prix_collaborateur": null,
            "d_veh_controle_technique": null,
            "d_veh_rentree_previsionnelle": null,
            "dh_veh_spot": "2025-04-19 23:17:00",
            "dh_veh_frevo_reels_modifies": "2025-04-26 10:41:40",
            "dh_veh_calcul": "2025-04-19 23:17:00",
            "f_veh_prix_finance_ttc": null,
            "s_veh_prix_finance_conditions": null,
            "aCLDEDTO": null,
            "aCVehiculeImageEstimationDTO": null,
            "genBVehiculeLPE": false,
            "sGenIDVehiculeB2L": "0d8b1c4e0a653597680008a86ffdf341_2",
            "aFinancements": null,
            "gen_s_pay_code": null
        }

;

        foreach var theCaller in clientMap {
            log:printInfo("sending message to caller...");
            var result = (<websocket:Caller>theCaller)->writeTextMessage(payload.toJsonString());
            if result is error {
                log:printError("Erreur d'envoi WebSocket", result);
            }
        }

    }
}
